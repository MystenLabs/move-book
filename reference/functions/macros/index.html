<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-reference docs-version-current docs-doc-page docs-doc-id-functions/macros" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Macro Functions | Reference | The Move Book</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://move-book.com/reference/functions/macros"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="algolia-site-verification" content="BCA21DA2879818D2"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-reference-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-reference-current"><meta data-rh="true" property="og:title" content="Macro Functions | Reference | The Move Book"><link data-rh="true" rel="icon" href="/favicon.svg"><link data-rh="true" rel="canonical" href="https://move-book.com/reference/functions/macros"><link data-rh="true" rel="alternate" href="https://move-book.com/reference/functions/macros" hreflang="en"><link data-rh="true" rel="alternate" href="https://move-book.com/reference/functions/macros" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B1E7R0BHX4"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-B1E7R0BHX4",{anonymize_ip:!0})</script>



<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Rubik:wght@300&amp;amp;display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"><link rel="stylesheet" href="/assets/css/styles.4d9dba2f.css">
<script src="/assets/js/runtime~main.a2b2be8f.js" defer="defer"></script>
<script src="/assets/js/main.c2d82c5e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_OH5z" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"></a><a class="navbar__item navbar__link" href="/">Move Book</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/reference">Move Reference</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_aspp"><div class="navbar__search searchBarContainer_reza" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_Kpxf" value=""><div class="loadingRing_LRD_ searchBarLoadingRing_lY7z"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/MystenLabs/move-book" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><i class="fab fa-github"></i></a><div class="toggle_MW0i colorModeToggle_RHuM"><button class="clean-btn toggleButton_yw5v toggleButtonDisabled_BJd7" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><i aria-hidden="true" class="toggleIcon_oIOL lightToggleIcon_SFTY fas fa-moon"></i><i aria-hidden="true" class="toggleIcon_oIOL darkToggleIcon_ekgs fas fa-sun"></i><i aria-hidden="true" class="toggleIcon_oIOL systemToggleIcon_yi_a fas fa-moon"></i></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_wWoK"><div class="docsWrapper_nrtX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_xs6u" type="button"></button><div class="docRoot_XRUv"><aside class="theme-doc-sidebar-container docSidebarContainer_vhZZ"><div class="sidebarViewport_HXJ_"><div class="sidebar_B2tA"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_RelJ"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/reference/">The Move Reference</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Getting Started</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/modules">1. Modules</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active">Basic Concepts</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" tabindex="0" href="/reference/primitive-types">2. Primitive Types</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/primitive-types/integers">2.1 Integers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/primitive-types/bool">2.2 Bool</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/primitive-types/address">2.3 Address</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/primitive-types/vector">2.4 Vector</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/primitive-types/references">2.5 References</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/primitive-types/tuples">2.6 Tuples and Unit</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/variables">3. Local Variables and Scopes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/equality">4. Equality</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" tabindex="0" href="/reference/abort-and-assert">5. Abort and Assert</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/abort-and-assert/clever-errors">5.1 Clever Errors</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link" tabindex="0" href="/reference/control-flow">6. Control Flow</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/control-flow/conditionals">6.1 Conditional Expressions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/control-flow/loops">6.2 Loops</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/control-flow/labeled-control-flow">6.3 Labeled Control Flow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/control-flow/pattern-matching">6.4 Pattern Matching</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active" tabindex="0" href="/reference/functions">7. Functions</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/reference/functions/macros">7.1 Macros</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/structs">8. Structs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/enums">9. Enums</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/constants">10. Constants</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/generics">11. Generics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/abilities">12. Abilities</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/uses">13. Uses and Aliases</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Advanced Concepts</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/method-syntax">14. Method Syntax</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/index-syntax">15. Index Syntax</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Tooling</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/packages">16. Packages</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/unit-testing">17. Unit Testing</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Reference</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/coding-conventions">18. Coding Conventions</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link">Deprecated</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/reference/friends">19. Friends</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_oT2n"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_LCKf"><div class="docItemContainer_Jixr"><article><div class="tocCollapsible_vYTS theme-doc-toc-mobile tocMobile_QhsY"><button type="button" class="clean-btn tocCollapsibleButton_nB9w">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Macro Functions</h1></header>
<p>Macro functions are a way of defining functions that are expanded during compilation at each call
site. The arguments of the macro are not evaluated eagerly like a normal function, and instead are
substituted by expression. In addition, the caller can supply code to the macro via
<a href="#lambdas">lambdas</a>.</p>
<p>These expression substitution mechanics make <span class="inline-code">macro</span> functions similar
<a href="https://en.wikipedia.org/wiki/Macro_(computer_science)" target="_blank" rel="noopener noreferrer">to macros found in other programming languages</a>;
however, they are more constrained in Move than you might expect from other languages. The
parameters and return values of <span class="inline-code">macro</span> functions are still typed--though this can be partially
relaxed with the <a href="/reference/generics#_-type"><span class="inline-code">_</span> type</a>. The upside of this restriction however, is that
<span class="inline-code">macro</span> functions can be used anywhere a normal function can be used, which is notably helpful with
<a href="/reference/method-syntax">method syntax</a>.</p>
<p>A more extensive
<a href="https://en.wikipedia.org/wiki/Macro_(computer_science)#Syntactic_macros" target="_blank" rel="noopener noreferrer">syntactic macro</a> system
may come in the future.</p>
<h2 class="anchor anchorWithStickyNavbar_kl3l" id="syntax">Syntax<a href="#syntax" class="hash-link" aria-label="Direct link to Syntax" title="Direct link to Syntax">​</a></h2>
<p><span class="inline-code">macro</span> functions have a similar syntax to normal functions. However, all type parameter names and
all parameter names must start with a <span class="inline-code">$</span>. Note that <span class="inline-code">_</span> can still be used by itself, but not as a
prefix, and <span class="inline-code">$_</span> must be used instead.</p>
<div class="language-text codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-text codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">&lt;visibility&gt;? macro fun &lt;identifier&gt;&lt;[$type_parameters: constraint],*&gt;([$identifier: type],*): &lt;return_type&gt; &lt;function_body&gt;</span><br></span></code></pre></div></div>
<p>For example, the following <span class="inline-code">macro</span> function takes a vector and a lambda, and applies the lambda to
each element of the vector to construct a new vector.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">map</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">| -&gt; </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">): </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">&gt; {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> v = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    v.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">reverse</span><span class="token plain">();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> i = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> result = </span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[];</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">while</span><span class="token plain"> (!v.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">is_empty</span><span class="token plain">()) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        result.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">push_back</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(v.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">pop_back</span><span class="token plain">()));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        i = i + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    result</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The <span class="inline-code">$</span> is there to indicate that the parameters (both type and value parameters) do not behave like
their normal, non-macro counterparts. For type parameters, they can be instantiated with any type
(even a reference type <span class="inline-code">&amp;</span> or <span class="inline-code">&amp;mut</span>), and they will satisfy any constraint. Similarly for
parameters, they will not be evaluated eagerly, and instead the argument expression will be
substituted at each usage.</p>
<h2 class="anchor anchorWithStickyNavbar_kl3l" id="lambdas">Lambdas<a href="#lambdas" class="hash-link" aria-label="Direct link to Lambdas" title="Direct link to Lambdas">​</a></h2>
<p>Lambdas are a new type of expression that can only be used with <span class="inline-code">macro</span>s. These are used to pass
code from the caller into the body of the <span class="inline-code">macro</span>. While the substitution is done at compile time,
they are used similarly to <a href="https://en.wikipedia.org/wiki/Anonymous_function" target="_blank" rel="noopener noreferrer">anonymous functions</a>,
<a href="https://en.wikipedia.org/wiki/Lambda_calculus" target="_blank" rel="noopener noreferrer">lambdas</a>, or
<a href="https://en.wikipedia.org/wiki/Closure_(computer_programming)" target="_blank" rel="noopener noreferrer">closures</a> in other languages.</p>
<p>As seen in the example above (<span class="inline-code">$f: |$T| -&gt; $U</span>), lambda types are defined with the syntax</p>
<div class="language-text codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-text codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|&lt;type&gt;,*| (-&gt; &lt;type&gt;)?</span><br></span></code></pre></div></div>
<p>A few examples</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u128</span><span class="token plain"> </span><span class="token comment" style="color:#A0A1A7">// a lambda that takes two u64s and returns a u128</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|&amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;| -&gt; &amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain"> </span><span class="token comment" style="color:#A0A1A7">// a lambda that takes a &amp;mut vector&lt;u8&gt; and returns a &amp;mut u8</span><br></span></code></pre></div></div>
<p>If the return type is not annotated, it is unit <span class="inline-code">()</span> by default.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:#A0A1A7">// the following are equivalent</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|&amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;, </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">|</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|&amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;, </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; ()</span><br></span></code></pre></div></div>
<p>Lambda expressions are then defined at the call site of the <span class="inline-code">macro</span> with the syntax</p>
<div class="language-text codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-text codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|(&lt;identifier&gt; (: &lt;type&gt;)?),*| &lt;expression&gt;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">|(&lt;identifier&gt; (: &lt;type&gt;)?),*| -&gt; &lt;type&gt; { &lt;expression&gt; }</span><br></span></code></pre></div></div>
<p>Note that if the return type is annotated, the body of the lambda must be enclosed in <span class="inline-code">{}</span>.</p>
<p>Using the <span class="inline-code">map</span> macro defined above</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> v = </span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">3</span><span class="token plain">];</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">doubled</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt; = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(v, |x| </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> * x);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">bytes</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;&gt; = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(v, |x| std::</span><span class="token property-value">bcs</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">to_bytes</span><span class="token plain">(&amp;x));</span><br></span></code></pre></div></div>
<p>And with type annotations</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">doubled</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt; = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(v, |</span><span class="token property-name function-argument struct-property-name">x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> * x); </span><span class="token comment" style="color:#A0A1A7">// return type annotation optional</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">bytes</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;&gt; = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(v, |</span><span class="token property-name function-argument struct-property-name">x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt; { std::</span><span class="token property-value">bcs</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">to_bytes</span><span class="token plain">(&amp;x) });</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="capturing">Capturing<a href="#capturing" class="hash-link" aria-label="Direct link to Capturing" title="Direct link to Capturing">​</a></h3>
<p>Lambda expressions can also refer to variables in the scope where the lambda is defined. This is
sometimes called &quot;capturing&quot;.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> res = </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> incremented = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">3</span><span class="token plain">], |x| x + res);</span><br></span></code></pre></div></div>
<p>Any variable can be captured, including mutable and immutable references.</p>
<p>See the <a href="#iterating-over-a-vector">Examples</a> section for more complicated usages.</p>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="limitations">Limitations<a href="#limitations" class="hash-link" aria-label="Direct link to Limitations" title="Direct link to Limitations">​</a></h3>
<p>Currently, lambdas can only be used directly in the call of a <span class="inline-code">macro</span> function. They cannot be bound
to a variable. For example, the following is code will produce an error:</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> f = |x| </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> * x;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:#A0A1A7">//      ^^^^^^^^^ Error! Lambdas must be used directly in &#x27;macro&#x27; calls</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">doubled</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt; = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">3</span><span class="token plain">], f);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_kl3l" id="typing">Typing<a href="#typing" class="hash-link" aria-label="Direct link to Typing" title="Direct link to Typing">​</a></h2>
<p>Like normal functions, <span class="inline-code">macro</span> functions are typed--the types of the parameters and return value
must be annotated. However, the body of the function is not type checked until the macro is
expanded. This means that not all usages of a given macro may be valid. For example</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">add_one</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">): </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain"> + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The above macro will not type check if <span class="inline-code">$T</span> is not a primitive integer type.</p>
<p>This can be particularly useful in conjunction with <a href="/reference/method-syntax">method syntax</a>, where the
function is not resolved until after the macro is expanded.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">call_foo</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">): &amp;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This macro will only expand successfully if <span class="inline-code">$T</span> has a method <span class="inline-code">foo</span> that returns a reference <span class="inline-code">&amp;$U</span>.
As described in the <a href="#hygiene">hygiene</a> section, <span class="inline-code">foo</span> will be resolved based on the scope where
<span class="inline-code">call_foo</span> was defined--not where it was expanded.</p>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="type-parameters">Type Parameters<a href="#type-parameters" class="hash-link" aria-label="Direct link to Type Parameters" title="Direct link to Type Parameters">​</a></h3>
<p>Type parameters can be instantiated with any type, including reference types <span class="inline-code">&amp;</span> and <span class="inline-code">&amp;mut</span>. They
can also be instantiated with <a href="/reference/primitive-types/tuples">tuple types</a>, though the utility of this
is limited currently since tuples cannot be bound to a variable.</p>
<p>This relaxation forces the constraints of a type parameter to be satisfied at the call site in a way
that does not normally occur. It is generally recommended however to add all necessary constraints
to a type parameter. For example</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token struct-or-enum-definition struct-keyword keyword" style="color:hsl(301, 63%, 40%)">struct</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">NoAbilities</span><span class="token struct-or-enum-definition">(</span><span class="token plain">)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token struct-or-enum-definition struct-keyword keyword" style="color:hsl(301, 63%, 40%)">struct</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">CopyBox</span><span class="token struct-or-enum-definition">&lt;</span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">T</span><span class="token struct-or-enum-definition">: </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">copy</span><span class="token struct-or-enum-definition">&gt; </span><span class="token struct-or-enum-definition struct-has keyword" style="color:hsl(301, 63%, 40%)">has</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">copy</span><span class="token struct-or-enum-definition">, </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">drop</span><span class="token struct-or-enum-definition"> {</span><span class="token plain"> </span><span class="token property-name function-argument struct-property-name">value</span><span class="token plain">: </span><span class="token struct-types entity" style="color:#C18401">T</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">make_box</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">): </span><span class="token struct-types entity" style="color:#C18401">CopyBox</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt; {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token struct-types entity" style="color:#C18401">CopyBox</span><span class="token plain"> { </span><span class="token property-name function-argument struct-property-name">value</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>This macro will expand only if <span class="inline-code">$T</span> is instantiated with a type with the <span class="inline-code">copy</span> ability.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro-call macro-name support" style="color:#0184BC">make_box</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">); </span><span class="token comment" style="color:#A0A1A7">// Valid!</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro-call macro-name support" style="color:#0184BC">make_box</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token struct-types entity" style="color:#C18401">NoAbilities</span><span class="token plain">()); </span><span class="token comment" style="color:#A0A1A7">// Error! &#x27;NoAbilities&#x27; does not have the copy ability</span><br></span></code></pre></div></div>
<p>The suggested declaration of <span class="inline-code">make_box</span> would be to add the <span class="inline-code">copy</span> constraint to the type parameter.
This then communicates to the caller that the type must have the <span class="inline-code">copy</span> ability.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">make_box</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">: </span><span class="token abilities support" style="color:#0184BC">copy</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">): </span><span class="token struct-types entity" style="color:#C18401">CopyBox</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt; {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token struct-types entity" style="color:#C18401">CopyBox</span><span class="token plain"> { </span><span class="token property-name function-argument struct-property-name">value</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>One might reasonably ask then, why have this relaxation if the recommendation is not to use it? The
constraints on type parameters simply cannot be enforced in all cases because the bodies are not
checked until expansion. In the following example, the <span class="inline-code">copy</span> constraint on <span class="inline-code">$T</span> is not necessary in
the signature, but is necessary in the body.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">read_ref</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$r</span><span class="token plain">: &amp;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">): </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    *</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$r</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>If however, you want to have an extremely relaxed type signature, it is instead recommended to use
the <a href="#_-type"><span class="inline-code">_</span> type</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="_-type"><span class="inline-code">_</span> Type<a href="#_-type" class="hash-link" aria-label="Direct link to _-type" title="Direct link to _-type">​</a></h3>
<p>Normally, the <a href="/reference/generics#_-type"><span class="inline-code">_</span> placeholder type</a> is used in expressions to allow for
partial annotations of type arguments. However, with <span class="inline-code">macro</span> functions, the <span class="inline-code">_</span> type can be used in
place of type parameters to relax the signature for any type. This should increase the ergonomics of
declaring &quot;generic&quot; <span class="inline-code">macro</span> functions.</p>
<p>For example, we could take any combination of integers and add them together.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">add</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token property-value">_</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$y</span><span class="token plain">: </span><span class="token property-value">_</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$z</span><span class="token plain">: </span><span class="token property-value">_</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u256</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain"> </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> </span><span class="token built-in-types support" style="color:#0184BC">u256</span><span class="token plain">) + (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$y</span><span class="token plain"> </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> </span><span class="token built-in-types support" style="color:#0184BC">u256</span><span class="token plain">) + (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$z</span><span class="token plain"> </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> </span><span class="token built-in-types support" style="color:#0184BC">u256</span><span class="token plain">)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Additionally, the <span class="inline-code">_</span> type can be instantiated <em>multiple</em> times with different types. For example</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token struct-or-enum-definition struct-keyword keyword" style="color:hsl(301, 63%, 40%)">struct</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">Box</span><span class="token struct-or-enum-definition">&lt;</span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">T</span><span class="token struct-or-enum-definition">&gt; </span><span class="token struct-or-enum-definition struct-has keyword" style="color:hsl(301, 63%, 40%)">has</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">copy</span><span class="token struct-or-enum-definition">, </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">drop</span><span class="token struct-or-enum-definition">, </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">store</span><span class="token struct-or-enum-definition"> {</span><span class="token plain"> </span><span class="token property-name function-argument struct-property-name">value</span><span class="token plain">: </span><span class="token struct-types entity" style="color:#C18401">T</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">create_two</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |_| -&gt; </span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain">&lt;_&gt;): (</span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;, </span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u16</span><span class="token plain">&gt;) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0u8</span><span class="token plain">), </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0u16</span><span class="token plain">))</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>If we declared the function with type parameters instead, the types would have to unify to a common
type, which is not possible in this case.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">create_two</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">| -&gt; </span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;): (</span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">&gt;, </span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u16</span><span class="token plain">&gt;) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0u8</span><span class="token plain">), </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0u16</span><span class="token plain">))</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">//           ^^^^ Error! expected `u8` but found `u16`</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> (a, b) = </span><span class="token macro-call macro-name support" style="color:#0184BC">create_two</span><span class="token macro-call">!</span><span class="token plain">(|value| </span><span class="token struct-types entity" style="color:#C18401">Box</span><span class="token plain"> { value });</span><br></span></code></pre></div></div>
<p>In this case, <span class="inline-code">$T</span> must be instantiated with a single type, but inference finds that <span class="inline-code">$T</span> must be
bound to both <span class="inline-code">u8</span> and <span class="inline-code">u16</span>.</p>
<p>There is a tradeoff however, as the <span class="inline-code">_</span> type conveys less meaning and intention for the caller.
Consider <span class="inline-code">map</span> macro from above re-declared with <span class="inline-code">_</span> instead of <span class="inline-code">$T</span> and <span class="inline-code">$U</span>.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">map</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;_&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |_| -&gt; _): </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;_&gt; {</span><br></span></code></pre></div></div>
<p>There is no longer any indication of behavior of <span class="inline-code">$f</span> at the type level. The caller must gain
understanding from comments or the body of the macro.</p>
<h2 class="anchor anchorWithStickyNavbar_kl3l" id="expansion-and-substitution">Expansion and Substitution<a href="#expansion-and-substitution" class="hash-link" aria-label="Direct link to Expansion and Substitution" title="Direct link to Expansion and Substitution">​</a></h2>
<p>The body of the <span class="inline-code">macro</span> is substituted into the call site at compile time. Each parameter is
replaced by the <em>expression</em>, not the value, of its argument. For lambdas, additional local
variables can have values bound within the context of the <span class="inline-code">macro</span> body.</p>
<p>Taking a very simple example</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">apply</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>With the call site</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> incremented = </span><span class="token macro-call macro-name support" style="color:#0184BC">apply</span><span class="token macro-call">!</span><span class="token plain">(|x| x + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">5</span><span class="token plain">);</span><br></span></code></pre></div></div>
<p>This will roughly be expanded to</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> incremented = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = { </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">5</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    { x + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>Again, the value of <span class="inline-code">x</span> is not substituted, but the expression <span class="inline-code">5</span> is. This might mean that an
argument is evaluated multiple times, or not at all, depending on the body of the <span class="inline-code">macro</span>.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">dup</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> sum = </span><span class="token macro-call macro-name support" style="color:#0184BC">dup</span><span class="token macro-call">!</span><span class="token plain">(|x, y| x + y, </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">());</span><br></span></code></pre></div></div>
<p>is expanded to</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> sum = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = { </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">() };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> y = { </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">() };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    { x + y }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>Note that <span class="inline-code">foo()</span> will be called twice. Which would not happen if <span class="inline-code">dup</span> were a normal function.</p>
<p>It is often recommended to create predictable evaluation behavior by binding arguments to local
variables.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">dup</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> a = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(a, a)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Now that same call site will expand to</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> sum = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> a = { </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">() };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = { a };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> y = { a };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        { x + y }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">};</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="hygiene">Hygiene<a href="#hygiene" class="hash-link" aria-label="Direct link to Hygiene" title="Direct link to Hygiene">​</a></h3>
<p>In the example above, the <span class="inline-code">dup</span> macro had a local variable <span class="inline-code">a</span> that was used to bind the argument
<span class="inline-code">$x</span>. You might ask, what would happen if the variable was instead named <span class="inline-code">x</span>? Would that conflict
with the <span class="inline-code">x</span> in the lambda?</p>
<p>The short answer is, no. <span class="inline-code">macro</span> functions are
<a href="https://en.wikipedia.org/wiki/Hygienic_macro" target="_blank" rel="noopener noreferrer">hygienic</a>, meaning that the expansion of <span class="inline-code">macro</span>s and
lambdas will not accidentally capture variables from another scope.</p>
<p>The compiler does this by associating a unique number with each scope. When the <span class="inline-code">macro</span> is expanded,
the macro body gets its own scope. Additionally, the arguments are re-scoped on each usage.</p>
<p>Modifying the <span class="inline-code">dup</span> macro to use <span class="inline-code">x</span> instead of <span class="inline-code">a</span></p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">dup</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> a = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(a, a)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The expansion of the call site</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token comment" style="color:#A0A1A7">// let sum = dup!(|x, y| x + y, foo());</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> sum = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> = { </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">() };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> = { x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> y#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> = { x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        { x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> + y#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>This is an approximation of the compiler&#x27;s internal representation, some details are omitted for the
simplicity of this example.</p>
<p>And each usage of an argument is re-scoped so that the different usages do not conflict.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">apply_twice</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">) + </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> result = </span><span class="token macro-call macro-name support" style="color:#0184BC">apply_twice</span><span class="token macro-call">!</span><span class="token plain">(|x| x + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">, { </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">5</span><span class="token plain">; x });</span><br></span></code></pre></div></div>
<p>Expands to</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> result = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> = { </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> = { </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">5</span><span class="token plain"> }; x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        { x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> + x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    +</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">3</span><span class="token plain"> = { </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">4</span><span class="token plain"> = { </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">5</span><span class="token plain"> }; x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">4</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        { x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">3</span><span class="token plain"> + x#</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">3</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>Similar to variable hygiene, <a href="/reference/method-syntax">method resolution</a> is also scoped to the macro
definition. For example</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token struct-or-enum-definition struct-keyword keyword" style="color:hsl(301, 63%, 40%)">struct</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">S</span><span class="token struct-or-enum-definition"> {</span><span class="token plain"> </span><span class="token property-name function-argument struct-property-name">f</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token property-name function-argument struct-property-name">g</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">f</span><span class="token plain">(</span><span class="token property-name function-argument struct-property-name">s</span><span class="token plain">: &amp;</span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    s.f</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">g</span><span class="token plain">(</span><span class="token property-name function-argument struct-property-name">s</span><span class="token plain">: &amp;</span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    s.g</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token use-import-fun use-keyword keyword" style="color:hsl(301, 63%, 40%)">use</span><span class="token use-import-fun"> </span><span class="token use-import-fun fun-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token use-import-fun"> f </span><span class="token use-import-fun as-keyword keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token use-import-fun"> foo;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">call_foo</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$s</span><span class="token plain">: &amp;</span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> s = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$s</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    s.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The method call <span class="inline-code">foo</span> will in this case always resolve to the function <span class="inline-code">f</span>, even if <span class="inline-code">call_foo</span> is
used in a scope where <span class="inline-code">foo</span> is bound to a different function, such as <span class="inline-code">g</span>.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">example</span><span class="token plain">(</span><span class="token property-name function-argument struct-property-name">s</span><span class="token plain">: &amp;</span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token use-import-fun use-keyword keyword" style="color:hsl(301, 63%, 40%)">use</span><span class="token use-import-fun"> </span><span class="token use-import-fun fun-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token use-import-fun"> g </span><span class="token use-import-fun as-keyword keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token use-import-fun"> foo;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">call_foo</span><span class="token macro-call">!</span><span class="token plain">(s) </span><span class="token comment" style="color:#A0A1A7">// expands to &#x27;f(s)&#x27;, not &#x27;g(s)&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Due to this though, unused <span class="inline-code">use fun</span> declarations might not get warnings in modules with <span class="inline-code">macro</span>
functions.</p>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="control-flow">Control Flow<a href="#control-flow" class="hash-link" aria-label="Direct link to Control Flow" title="Direct link to Control Flow">​</a></h3>
<p>Similar to variable hygiene, control flow constructs are also always scoped to where they are
defined, not to where they are expanded.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">maybe_div</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$y</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> y = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$y</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (y == </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">) </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    x / y</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>At the call site, <span class="inline-code">return</span> will always return from the <span class="inline-code">macro</span> body, not from the caller.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">result</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt; = </span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token macro-call macro-name support" style="color:#0184BC">maybe_div</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">10</span><span class="token plain">, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">)];</span><br></span></code></pre></div></div>
<p>Will expand to</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token let-statement">result</span><span class="token plain">: </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt; = </span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token label string" style="color:hsl(119, 34%, 47%)">&#x27;a:</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = { </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">10</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> y = { </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (y == </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">) </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> &#x27;a </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    x / y</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}];</span><br></span></code></pre></div></div>
<p>Where <span class="inline-code">return &#x27;a 0</span> will return to the block <span class="inline-code">&#x27;a: { ... }</span> and not to the caller&#x27;s body. See the
section on <a href="/reference/control-flow/labeled-control-flow">labeled control flow</a> for more details.</p>
<p>Similarly, <span class="inline-code">return</span> in a lambda will return from the lambda, not from the <span class="inline-code">macro</span> body and not from
the outer function.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">apply</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>and</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> result = </span><span class="token macro-call macro-name support" style="color:#0184BC">apply</span><span class="token macro-call">!</span><span class="token plain">(|x| { </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (x == </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">) </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">; x + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> }, </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">100</span><span class="token plain">);</span><br></span></code></pre></div></div>
<p>will expand to</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> result = {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = { </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">100</span><span class="token plain"> };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token label string" style="color:hsl(119, 34%, 47%)">&#x27;a:</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (x == </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">) </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> &#x27;a </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">};</span><br></span></code></pre></div></div>
<p>In addition to returning from the lambda, a label can be used to return to the outer function. In
the <span class="inline-code">vector::any</span> macro, a <span class="inline-code">return</span> with a label is used to return from the entire <span class="inline-code">macro</span> early</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">any</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">: &amp;</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |&amp;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">bool</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">bool</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> v = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token label string" style="color:hsl(119, 34%, 47%)">&#x27;any:</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        v.</span><span class="token macro-call macro-name support" style="color:#0184BC">do_ref</span><span class="token macro-call">!</span><span class="token plain">(|e| </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(e)) </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> &#x27;any </span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">true</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The <span class="inline-code">return &#x27;any true</span> exits from the &quot;loop&quot; early when the condition is met. Otherwise, the macro
&quot;returns&quot; <span class="inline-code">false</span>.</p>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="method-syntax">Method Syntax<a href="#method-syntax" class="hash-link" aria-label="Direct link to Method Syntax" title="Direct link to Method Syntax">​</a></h3>
<p>When applicable, <span class="inline-code">macro</span> functions can be called using <a href="/reference/method-syntax">method syntax</a>. When
using method syntax, the evaluation of the arguments will change in that the first argument (the
&quot;receiver&quot; of the method) will be evaluated outside of the macro expansion. This example is
contrived, but will concisely demonstrate the behavior.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token struct-or-enum-definition struct-keyword keyword" style="color:hsl(301, 63%, 40%)">struct</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition struct-name entity" style="color:#C18401">S</span><span class="token struct-or-enum-definition">() </span><span class="token struct-or-enum-definition struct-has keyword" style="color:hsl(301, 63%, 40%)">has</span><span class="token struct-or-enum-definition"> </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">copy</span><span class="token struct-or-enum-definition">, </span><span class="token struct-or-enum-definition abilities support" style="color:#0184BC">drop</span><span class="token struct-or-enum-definition">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">(): </span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain"> { </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">abort</span><span class="token plain"> </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain"> }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token visibility keyword" style="color:hsl(301, 63%, 40%)">public</span><span class="token plain"> </span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">maybe_s</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$s</span><span class="token plain">: </span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$cond</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">bool</span><span class="token plain">): </span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$cond</span><span class="token plain">) </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$s</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> </span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Even though <span class="inline-code">foo()</span> will abort, its return type can be used to start a method call.</p>
<p><span class="inline-code">$s</span> will not be evaluated if <span class="inline-code">$cond</span> is <span class="inline-code">false</span>, and under a normal non-method call, an argument of
<span class="inline-code">foo()</span> would not be evaluated and would not abort. The following example demonstrates <span class="inline-code">$s</span> not
being evaluated with an argument of <span class="inline-code">foo()</span>.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro-call macro-name support" style="color:#0184BC">maybe_s</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">(), </span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain">) </span><span class="token comment" style="color:#A0A1A7">// does not abort</span><br></span></code></pre></div></div>
<p>It becomes more clear as to why it does not abort when looking at the expanded form</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (</span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain">) </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> </span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">()</span><br></span></code></pre></div></div>
<p>However, when using method syntax, the first argument is evaluated before the macro is expanded. So
the same argument of <span class="inline-code">foo()</span> for <span class="inline-code">$s</span> will now be evaluated and will abort.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">().</span><span class="token macro-call macro-name support" style="color:#0184BC">maybe_s</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain">) </span><span class="token comment" style="color:#A0A1A7">// aborts</span><br></span></code></pre></div></div>
<p>We can see this more clearly when looking the expanded form</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> tmp = </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">foo</span><span class="token plain">(); </span><span class="token comment" style="color:#A0A1A7">// aborts</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (</span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain">) tmp</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> </span><span class="token struct-types entity" style="color:#C18401">S</span><span class="token plain">()</span><br></span></code></pre></div></div>
<p>Conceptually, the receiver for a method call is bound to a temporary variable before the macro is
expanded, which forces the evaluation and thus the abort.</p>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="parameter-limitations">Parameter Limitations<a href="#parameter-limitations" class="hash-link" aria-label="Direct link to Parameter Limitations" title="Direct link to Parameter Limitations">​</a></h3>
<p>The parameters of a <span class="inline-code">macro</span> function must always be used as expressions. They cannot be used in
situations where the argument might be re-interpreted. For example, the following is not allowed</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">no</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token property-value">_</span><span class="token plain">): </span><span class="token property-value">_</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">.f</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>The reason is that if the argument <span class="inline-code">$x</span> was not a reference, it would be borrowed first, which would
could re-interpret the argument. To get around this limitation, you should bind the argument to a
local variable.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">yes</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token property-value">_</span><span class="token plain">): </span><span class="token property-value">_</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    x.f</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_kl3l" id="examples">Examples<a href="#examples" class="hash-link" aria-label="Direct link to Examples" title="Direct link to Examples">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="lazy-arguments-assert_eq">Lazy arguments: assert_eq<a href="#lazy-arguments-assert_eq" class="hash-link" aria-label="Direct link to Lazy arguments: assert_eq" title="Direct link to Lazy arguments: assert_eq">​</a></h3>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">assert_eq</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$left</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$right</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$code</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> left = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$left</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> right = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$right</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (left != right) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        std::</span><span class="token property-value">debug</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">print</span><span class="token plain">(&amp;</span><span class="token string-literal string-literal-prefix">b&quot;</span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)">assertion failed.\n left: </span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal">&quot;</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        std::</span><span class="token property-value">debug</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">print</span><span class="token plain">(&amp;left);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        std::</span><span class="token property-value">debug</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">print</span><span class="token plain">(&amp;</span><span class="token string-literal string-literal-prefix">b&quot;</span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)">\n does not equal right: </span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal string-literal-content string" style="color:hsl(119, 34%, 47%)"></span><span class="token string-literal">&quot;</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        std::</span><span class="token property-value">debug</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">print</span><span class="token plain">(&amp;right);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">abort</span><span class="token plain"> </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$code</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>In this case the argument to <span class="inline-code">$code</span> is not evaluated unless the assertion fails.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro-call macro-name support" style="color:#0184BC">assert_eq</span><span class="token macro-call">!</span><span class="token plain">(</span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">true</span><span class="token plain">, </span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain">], </span><span class="token built-in-types support" style="color:#0184BC">vector</span><span class="token plain">[</span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">true</span><span class="token plain">, </span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain">], </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain"> / </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">); </span><span class="token comment" style="color:#A0A1A7">// division by zero is not evaluated</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="any-integer-square-root">Any integer square root<a href="#any-integer-square-root" class="hash-link" aria-label="Direct link to Any integer square root" title="Direct link to Any integer square root">​</a></h3>
<p>This macro calculates the integer square root for any integer type, besides <span class="inline-code">u256</span>.</p>
<p><span class="inline-code">$T</span> is the type of the input and <span class="inline-code">$bitsize</span> is the number of bits in that type, for example <span class="inline-code">u8</span>
has 8 bits. <span class="inline-code">$U</span> should be set to the next larger integer type, for example <span class="inline-code">u16</span> for <span class="inline-code">u8</span>.</p>
<p>In this <span class="inline-code">macro</span>, the type of the integer literals are <span class="inline-code">1</span> and <span class="inline-code">0</span> are annotated, e.g. <span class="inline-code">(1: $U)</span>
allowing for the type of the literal to differ with each call. Similarly, <span class="inline-code">as</span> can be used with the
type parameters <span class="inline-code">$T</span> and <span class="inline-code">$U</span>. This macro will then only successfully expand if <span class="inline-code">$T</span> and <span class="inline-code">$U</span> are
instantiated with the integer types.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">num_sqrt</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$bitsize</span><span class="token plain">: </span><span class="token built-in-types support" style="color:#0184BC">u8</span><span class="token plain">): </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> x = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$x</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> bit = (</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">) &lt;&lt; </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$bitsize</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> res = (</span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">: </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> x = x </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">while</span><span class="token plain"> (bit != </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (x &gt;= res + bit) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            x = x - (res + bit);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            res = (res &gt;&gt; </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">) + bit;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        } </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            res = res &gt;&gt; </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        bit = bit &gt;&gt; </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">2</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    };</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    res </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="iterating-over-a-vector">Iterating over a vector<a href="#iterating-over-a-vector" class="hash-link" aria-label="Direct link to Iterating over a vector" title="Direct link to Iterating over a vector">​</a></h3>
<p>The two <span class="inline-code">macro</span>s iterate over a vector, immutably and mutably respectively.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">for_imm</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">: &amp;</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |&amp;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">|) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> v = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> n = v.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">length</span><span class="token plain">();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> i = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">while</span><span class="token plain"> (i &lt; n) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(&amp;v[i]);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        i = i + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">for_mut</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">: &amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |&amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">|) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> v = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$v</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> n = v.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">length</span><span class="token plain">();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> i = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">while</span><span class="token plain"> (i &lt; n) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(&amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> v[i]);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        i = i + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>A few examples of usage</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">imm_examples</span><span class="token plain">(</span><span class="token property-name function-argument struct-property-name">v</span><span class="token plain">: &amp;</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt;) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// print all elements</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">for_imm</span><span class="token macro-call">!</span><span class="token plain">(v, |x| std::</span><span class="token property-value">debug</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">print</span><span class="token plain">(x));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// sum all elements</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> sum = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">for_imm</span><span class="token macro-call">!</span><span class="token plain">(v, |x| sum = sum + x);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// find the max element</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> max = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">for_imm</span><span class="token macro-call">!</span><span class="token plain">(v, |x| </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (x &gt; max) max = x);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">mut_examples</span><span class="token plain">(</span><span class="token property-name function-argument struct-property-name">v</span><span class="token plain">: &amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">vector</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt;) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// increment each element</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">for_mut</span><span class="token macro-call">!</span><span class="token plain">(v, |x| *x = *x + </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// set each element to the previous value, and the first to last value</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> prev = v[v.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">length</span><span class="token plain">() - </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">1</span><span class="token plain">];</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">for_mut</span><span class="token macro-call">!</span><span class="token plain">(v, |x| {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> tmp = *x;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        *x = prev;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        prev = tmp;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    });</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// set the max element to 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> </span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> max = &amp;</span><span class="token mut-keyword keyword" style="color:hsl(301, 63%, 40%)">mut</span><span class="token plain"> </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">for_mut</span><span class="token macro-call">!</span><span class="token plain">(v, |x| </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (*x &gt; *max) max = x);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    *max = </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_kl3l" id="non-loop-lambda-usage">Non-loop lambda usage<a href="#non-loop-lambda-usage" class="hash-link" aria-label="Direct link to Non-loop lambda usage" title="Direct link to Non-loop lambda usage">​</a></h3>
<p>Lambdas do not need to be used in loops, and are often useful for conditionally applying code.</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">inspect</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$opt</span><span class="token plain">: &amp;</span><span class="token struct-types entity" style="color:#C18401">Option</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |&amp;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">|) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> opt = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$opt</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">is_some</span><span class="token plain">()) </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">borrow</span><span class="token plain">())</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">is_some_and</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$opt</span><span class="token plain">: &amp;</span><span class="token struct-types entity" style="color:#C18401">Option</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |&amp;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">| -&gt; </span><span class="token built-in-types support" style="color:#0184BC">bool</span><span class="token plain">): </span><span class="token built-in-types support" style="color:#0184BC">bool</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> opt = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$opt</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">is_some</span><span class="token plain">()) </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">borrow</span><span class="token plain">())</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> </span><span class="token literals boolean" style="color:hsl(35, 99%, 36%)">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token macro keyword" style="color:hsl(301, 63%, 40%)">macro</span><span class="token plain"> </span><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">map</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">&gt;(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$opt</span><span class="token plain">: </span><span class="token struct-types entity" style="color:#C18401">Option</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">&gt;, </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">: |</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$T</span><span class="token plain">| -&gt; </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">): </span><span class="token struct-types entity" style="color:#C18401">Option</span><span class="token plain">&lt;</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$U</span><span class="token plain">&gt; {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> opt = </span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$opt</span><span class="token plain">;</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> (opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">is_some</span><span class="token plain">()) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        option::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">some</span><span class="token plain">(</span><span class="token macro-variable builtin" style="color:hsl(119, 34%, 47%)">$f</span><span class="token plain">(opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">destroy_some</span><span class="token plain">()))</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    } </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">else</span><span class="token plain"> {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        opt.</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">destroy_none</span><span class="token plain">();</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        option::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">none</span><span class="token plain">()</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    }</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>And some examples of usage</p>
<div class="language-move codeBlockContainer_AE_o theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_YOHW"><pre tabindex="0" class="prism-code language-move codeBlock_q9R9 thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_bu_M"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token function-keyword keyword" style="color:hsl(301, 63%, 40%)">fun</span><span class="token plain"> </span><span class="token function-name function" style="color:hsl(221, 87%, 60%)">examples</span><span class="token plain">(</span><span class="token property-name function-argument struct-property-name">opt</span><span class="token plain">: </span><span class="token struct-types entity" style="color:#C18401">Option</span><span class="token plain">&lt;</span><span class="token built-in-types support" style="color:#0184BC">u64</span><span class="token plain">&gt;) {</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// print the value if it exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token macro-call macro-name support" style="color:#0184BC">inspect</span><span class="token macro-call">!</span><span class="token plain">(&amp;opt, |x| std::</span><span class="token property-value">debug</span><span class="token plain">::</span><span class="token function-call function" style="color:hsl(221, 87%, 60%)">print</span><span class="token plain">(x));</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// check if the value is 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> is_zero = </span><span class="token macro-call macro-name support" style="color:#0184BC">is_some_and</span><span class="token macro-call">!</span><span class="token plain">(&amp;opt, |x| *x == </span><span class="token literals number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:#A0A1A7">// upcast the u64 to a u256</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token let-keyword keyword" style="color:hsl(301, 63%, 40%)">let</span><span class="token plain"> str_opt = </span><span class="token macro-call macro-name support" style="color:#0184BC">map</span><span class="token macro-call">!</span><span class="token plain">(opt, |x| x </span><span class="token control-flow keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> </span><span class="token built-in-types support" style="color:#0184BC">u256</span><span class="token plain">);</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">}</span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/reference/functions"><div class="pagination-nav__label"><i class="fa fa-angle-left"></i><span class="pagination-nav__label">Functions | Reference</span> </div></a><a class="pagination-nav__link pagination-nav__link--next" href="/reference/structs"><div class="pagination-nav__label"><span class="pagination-nav__label">8. Structs</span> <i class="fa fa-angle-right"></i></div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_VdoB thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#syntax" class="table-of-contents__link toc-highlight">Syntax</a></li><li><a href="#lambdas" class="table-of-contents__link toc-highlight">Lambdas</a><ul><li><a href="#capturing" class="table-of-contents__link toc-highlight">Capturing</a></li><li><a href="#limitations" class="table-of-contents__link toc-highlight">Limitations</a></li></ul></li><li><a href="#typing" class="table-of-contents__link toc-highlight">Typing</a><ul><li><a href="#type-parameters" class="table-of-contents__link toc-highlight">Type Parameters</a></li><li><a href="#_-type" class="table-of-contents__link toc-highlight"><code>_</code> Type</a></li></ul></li><li><a href="#expansion-and-substitution" class="table-of-contents__link toc-highlight">Expansion and Substitution</a><ul><li><a href="#hygiene" class="table-of-contents__link toc-highlight">Hygiene</a></li><li><a href="#control-flow" class="table-of-contents__link toc-highlight">Control Flow</a></li><li><a href="#method-syntax" class="table-of-contents__link toc-highlight">Method Syntax</a></li><li><a href="#parameter-limitations" class="table-of-contents__link toc-highlight">Parameter Limitations</a></li></ul></li><li><a href="#examples" class="table-of-contents__link toc-highlight">Examples</a><ul><li><a href="#lazy-arguments-assert_eq" class="table-of-contents__link toc-highlight">Lazy arguments: assert_eq</a></li><li><a href="#any-integer-square-root" class="table-of-contents__link toc-highlight">Any integer square root</a></li><li><a href="#iterating-over-a-vector" class="table-of-contents__link toc-highlight">Iterating over a vector</a></li><li><a href="#non-loop-lambda-usage" class="table-of-contents__link toc-highlight">Non-loop lambda usage</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>